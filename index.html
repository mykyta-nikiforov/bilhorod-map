<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>The map</title>
  <meta name="viewport" content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <script src='https://api.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.js'></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v0.9.0/mapbox-gl-language.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.css' rel='stylesheet' />
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
  <div class='sidebar'>
    <div class='heading'>
      <h1>Локації:</h1>
      <div id='listings' class='listings'></div>
    </div>
  </div>
  <div id='map' class='map'></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibW9yZ2Fudm9sdGVyIiwiYSI6IjhFYkNUSTAifQ.305FESLrPnFPOTdpD4L8dQ';
    var  map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/morganvolter/cj74nqu973o8g2rppjlrtrwl0',
      center: [30.3387, 46.1920],
      zoom: 13.7,
      maxBounds: [
        [30.2862, 46.1672],
        [30.3837, 46.2072]
      ],
      bearingSnap: 7
    });

    map.addControl(new mapboxgl.NavigationControl());

    map.addControl(new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true
      },
      trackUserLocation: true
    }));

    // Here I can't get the features
    var allFeatures = map.querySourceFeatures('morganvolter.cj77n1jkq1ale33jw0g9haxc0-2haga', {
      'sourceLayer': 'locations'
    });

    <!--------3d-buildings-------->
    map.on('load', function(e) {
      map.addLayer({
        'id': '3d-buildings',
        'source': 'composite',
        'source-layer': 'building',
        'filter': ['==', 'extrude', 'true'],
        'type': 'fill-extrusion',
        'minzoom': 16,
        'paint': {
          'fill-extrusion-color': '#aaa',
          'fill-extrusion-height': {
            'type': 'identity',
            'property': 'height'
          },
          'fill-extrusion-base': {
            'type': 'identity',
            'property': 'min_height'
          },
          'fill-extrusion-opacity': .4
        }
      });
      console.dir(allFeatures);
      // buildLocationList(allFeatures);
    });

    // List of all features, doesn't work because of lack of... allFeatures :)
    function buildLocationList(data) {
      for (i = 0; i < data.features.length; i++) {
        var currentFeature = data.features[i];
        var prop = currentFeature.properties;
        var listings = document.getElementById('listings');
        var listing = listings.appendChild(document.createElement('div'));
        listing.className = 'item';
        listing.id = 'listing-' + i;

        var link = listing.appendChild(document.createElement('a'));
        link.href = '#';
        link.className = 'title';
        link.dataPosition = i;
        link.innerHTML = prop.name;
        var details = listing.appendChild(document.createElement('div'));
        details.innerHTML = prop.description;
      }
    }

    map.on('click', function(e) {
      var features = map.queryRenderedFeatures(e.point, {
        layers: ['locations']
      });

      if (!features.length) {
        return;
      }
      var feature = features[0];
      flyToPoint(feature);
      var popup = new mapboxgl.Popup({
          offset: [0, -15]
        })
        .setLngLat(feature.geometry.coordinates)
        .setHTML('<h3>' + feature.properties.name + '</h3>' + '<p>' +
          feature.properties.description + '</p>')
        .addTo(map);
    });

    map.on('mousemove', function(e) {
      var features = map.queryRenderedFeatures(e.point, {
        layers: ['locations']
      });
      map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
    })


    function flyToPoint(currentFeature) {
      map.flyTo({
        center: currentFeature.geometry.coordinates,
        zoom: 16.5,
        pitch: 80
      });
    }
  </script>
</body>

</html>
